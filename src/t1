#!/usr/bin/python3
# -*- coding: utf-8 -*-

import sys
import os
import ipaddress
import json


# ###### Main program #######################################################
if len(sys.argv) < 2:
   sys.stderr.write('Usage: ' + sys.argv[0] + ' configuration_file\n')
   sys.exit(1)


try:
   jsonFile = open(sys.argv[1], 'r')
except Exception as e:
   sys.stderr.write('Unable to open input file: ' + str(e) + '\n')
   sys.exit(1)


try:
   jsonData = json.load(jsonFile)
except Exception as e:
   sys.stderr.write('Unable to read JSON: ' + str(e) + '\n')
   sys.exit(1)


print(json.dumps(jsonData, indent=3, sort_keys=True))


for stage in [ 1, 2 ]:
   for i in range(0, len(jsonData)):
      try:
         agentHostIP       = ipaddress.ip_address(jsonData[i]['agentHostIP'])
         agentTrafficClass = int(jsonData[i]['agentTrafficClass'])
         agentFromIP       = ipaddress.ip_address(jsonData[i]['agentFromIP'])
         probeID           = int(jsonData[i]['probeID'])

         if stage == 2:
            print('=> ', agentHostIP, agentTrafficClass, agentFromIP, probeID)

      except Exception as e:
         sys.stderr.write('Bad entry #' + str(i + 1) + ': ' + str(e) + '\n')
         sys.exit(1)
